<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklista ‚Äî Fj√§derrapporten</title>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Merriweather', serif;
      background-color: #f4f7f5;
      color: #2c2c2c;
    }

    header {
      position: relative;
      width: 100%;
      height: 260px;
      overflow: hidden;
      border-bottom: 1px solid #ccc;
    }

    .header-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    nav {
      background-color: #f0f5ef;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 2rem;
      padding: 1rem;
      border-bottom: 1px solid #c8d5c1;
    }
    nav a {
      text-decoration: none;
      color: #2c2c2c;
      font-weight: bold;
      font-size: 1rem;
    }
    nav a:hover { color: #3f5d3f; }

    main {
      max-width: 700px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    /* S√∂kbar */
    .sok-bar {
      width: 100%;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      font-family: 'Merriweather', serif;
      border: 1px solid #c8d5c1;
      border-radius: 8px;
      background: #fff;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }
    .sok-bar:focus {
      outline: none;
      border-color: #a8c0a8;
      box-shadow: 0 0 4px rgba(168,192,168,0.3);
    }

    /* Progress */
    .progress-info {
      text-align: center;
      font-size: 0.88rem;
      color: #555;
      margin-bottom: 0.35rem;
    }
    .progress-bar {
      width: 100%;
      height: 5px;
      background-color: #e0e8e0;
      border-radius: 3px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background-color: #7ea77e;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Bird cards */
    .bird-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
      margin-bottom: 1rem;
      padding: 1rem 1.2rem;
      transition: background-color 0.2s;
    }
    .bird-card.checked {
      background-color: #eef5ee;
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
    }

    .art-checkbox {
      margin-top: 0.2rem;
      width: 20px;
      height: 20px;
      accent-color: #7ea77e;
      cursor: pointer;
      flex-shrink: 0;
    }

    .card-names {
      flex: 1;
    }
    .sv-namn {
      font-size: 1.15rem;
      font-weight: bold;
      display: block;
    }
    .lat-namn {
      font-size: 0.85rem;
      font-style: italic;
      color: #666;
      display: block;
      margin-top: 0.1rem;
    }

    .bird-details {
      margin-top: 0.5rem;
      padding-left: 2.5rem;
    }
    .bird-details p {
      margin: 0.2rem 0;
      font-size: 0.87rem;
      color: #555;
    }

    .kommuner-tags {
      margin-top: 0.35rem;
    }
    .kommuntag {
      display: inline-block;
      font-size: 0.72rem;
      background-color: #f0f5ef;
      color: #3f5d3f;
      padding: 0.15rem 0.45rem;
      border-radius: 10px;
      margin-right: 0.25rem;
      margin-bottom: 0.2rem;
    }

    /* Ljud */
    .ljud-btn {
      background: none;
      border: 1px solid #a8c0a8;
      border-radius: 16px;
      padding: 0.2rem 0.65rem;
      font-size: 0.78rem;
      color: #3f5d3f;
      cursor: pointer;
      margin-top: 0.5rem;
      margin-left: 2.5rem;
      font-family: 'Merriweather', serif;
      transition: background-color 0.2s;
    }
    .ljud-btn:hover {
      background-color: #e8f3e8;
    }
    .ljud-btn.playing {
      background-color: #dbe8d1;
      border-color: #7ea77e;
    }

    footer {
      text-align: center;
      padding: 2rem 1rem;
      background-color: #e8ede7;
      color: #555;
      font-size: 0.9rem;
      margin-top: 4rem;
    }

    @media (max-width: 600px) {
      .sv-namn   { font-size: 1rem; }
      .lat-namn  { font-size: 0.78rem; }
      .bird-details { padding-left: 2.5rem; }
      .ljud-btn  { margin-left: 2.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <img src="bilder/header.png" alt="Fj√§derrapporten bakgrund" class="header-image" />
  </header>

  <nav>
    <a href="index.html">üè† Hem</a>
    <a href="checklistan.html">‚úÖ Checklista</a>
    <a href="info.html">‚ÑπÔ∏è Om</a>
  </nav>

  <main>
    <h2 style="text-align:center; margin-bottom:0.5rem;">Checklista ‚Äî H√∂gland</h2>

    <input type="search" class="sok-bar" id="sok" placeholder="S√∂k art‚Ä¶" />

    <div class="progress-info">
      Du har sett <strong><span id="checked-count">0</span></strong> av <span id="total-count">0</span> arter
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

    <div id="checklista-body"></div>
  </main>

  <footer>
    &copy; 2025 Fj√§derrapporten ‚Äî Naturen √§r alltid n√§rea.
  </footer>

  <script>
    const STORAGE_KEY = "checklista_checked";

    // --- localStorage ---
    function l√§sChecked() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? new Set(JSON.parse(raw)) : new Set();
      } catch { return new Set(); }
    }

    function sparaChecked(set) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
    }

    let checked  = l√§sChecked();
    let allArter = [];
    let artljud  = {};

    // --- Ljud (en k√§lla i taget) ---
    let currentAudio = null;
    let currentBtn   = null;

    function toggleSound(url, btn) {
      if (currentAudio && currentBtn === btn) {
        currentAudio.pause();
        currentAudio = null;
        currentBtn.classList.remove("playing");
        currentBtn.textContent = "üîä Lyssna";
        currentBtn = null;
        return;
      }

      if (currentAudio) {
        currentAudio.pause();
        currentBtn.classList.remove("playing");
        currentBtn.textContent = "üîä Lyssna";
      }

      currentAudio = new Audio(url);
      currentAudio.play().catch(() => {
        btn.classList.remove("playing");
        btn.textContent = "üîä Lyssna";
        currentAudio = null;
        currentBtn = null;
      });
      currentBtn = btn;
      btn.classList.add("playing");
      btn.textContent = "‚èπ Stopp";

      currentAudio.addEventListener("ended", () => {
        btn.classList.remove("playing");
        btn.textContent = "üîä Lyssna";
        currentAudio = null;
        currentBtn = null;
      });
    }

    // --- Progress ---
    function uppdateraProgress() {
      const total = allArter.length;
      const count = checked.size;
      document.getElementById("checked-count").textContent = count;
      document.getElementById("total-count").textContent   = total;
      document.getElementById("progress-fill").style.width = (total > 0 ? (count / total) * 100 : 0) + "%";
    }

    // --- S√∂k ---
    document.getElementById("sok").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll(".bird-card").forEach(card => {
        const art        = (card.dataset.art || "").toLowerCase();
        const scientific = (card.dataset.scientific || "").toLowerCase();
        card.style.display = (art.includes(term) || scientific.includes(term)) ? "" : "none";
      });
    });

    // --- Render ---
    function renderChecklista() {
      const container = document.getElementById("checklista-body");
      container.innerHTML = "";

      allArter.forEach(art => {
        const isChecked = checked.has(art.scientificName);

        const card = document.createElement("div");
        card.className  = "bird-card" + (isChecked ? " checked" : "");
        card.dataset.art       = art.art || "";
        card.dataset.scientific = art.scientificName || "";

        const artnamn = art.art
          ? art.art.charAt(0).toUpperCase() + art.art.slice(1)
          : "Ok√§nd";

        const f√∂rsta = art.f√∂rsta
          ? new Date(art.f√∂rsta).toLocaleDateString("sv-SE", { day: "numeric", month: "long", year: "numeric" })
          : "‚Äî";
        const sista = art.sista
          ? new Date(art.sista).toLocaleDateString("sv-SE", { day: "numeric", month: "long", year: "numeric" })
          : "‚Äî";

        const kommunTaggar = (art.kommuner || [])
          .map(k => `<span class="kommuntag">${k}</span>`)
          .join("");

        const ljud = artljud[art.scientificName]?.ljud || null;

        card.innerHTML = `
          <div class="card-top">
            <input type="checkbox" class="art-checkbox"
              data-scientific="${art.scientificName}"
              ${isChecked ? "checked" : ""} />
            <div class="card-names">
              <span class="sv-namn">${artnamn}</span>
              <span class="lat-namn">${art.scientificName}</span>
            </div>
          </div>
          <div class="bird-details">
            <p>F√∂rsta sedd: ${f√∂rsta}</p>
            <p>Sista sedd: ${sista}</p>
            <div class="kommuner-tags">${kommunTaggar}</div>
          </div>
          ${ljud ? `<button class="ljud-btn" title="Ljud fr√•n Xeno-Canto">üîä Lyssna</button>` : ""}
        `;

        // Checkbox event
        card.querySelector(".art-checkbox").addEventListener("change", (e) => {
          if (e.target.checked) {
            checked.add(art.scientificName);
            card.classList.add("checked");
          } else {
            checked.delete(art.scientificName);
            card.classList.remove("checked");
          }
          sparaChecked(checked);
          uppdateraProgress();
        });

        // Ljud event
        if (ljud) {
          const btn = card.querySelector(".ljud-btn");
          btn.addEventListener("click", () => toggleSound(ljud, btn));
        }

        container.appendChild(card);
      });

      uppdateraProgress();
    }

    // --- Init ---
    async function init() {
      try {
        const [checkRes, ljudRes] = await Promise.all([
          fetch("data/checklista.json"),
          fetch("data/artljud.json").catch(() => ({ json: () => ({}) }))
        ]);

        allArter = await checkRes.json();
        artljud  = await ljudRes.json();

        allArter.sort((a, b) => (a.art || "").localeCompare(b.art || "", "sv"));
        renderChecklista();
      } catch (e) {
        console.error("Fel vid laddning:", e);
        document.getElementById("checklista-body").innerHTML = "<p>Kunde inte ladda checklistan.</p>";
      }
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
